<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å£è…”æŒ‘æˆ°è³½ï¼šç†±ç‹—ï¼æ°£çƒï¼æ£’æ£’ç³–</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main>
    <h1>å£è…”æŒ‘æˆ°è³½</h1>

    <section id="ui">
      <div class="row">
        <label>é¸æ“‡é—œå¡ï¼š</label>
        <select id="mode">
          <option value="hotdog">å˜´å·´åˆ‡ç†±ç‹—ï¼ˆé–‹åˆæ¬¡æ•¸ï¼‰</option>
          <option value="balloon">å¹æ°£çƒï¼ˆé€£çºŒå¹æ°£ï¼‰</option>
          <option value="lollipop">èˆ”æ£’æ£’ç³–ï¼ˆå¿«é€Ÿé–‹åˆï¼‰</option>
        </select>
        <button id="startBtn">é–‹å§‹</button>
        <button id="resetBtn">é‡ä¾†</button>
      </div>

      <div class="row">
        <div>éº¥å…‹é¢¨éŸ³é‡ï¼š<span id="volVal">0.00</span></div>
        <div class="bar"><div id="volBar"></div></div>
      </div>

      <div class="row">
        <div>ç‹€æ…‹ï¼š<span id="stateText">å¾…æ©Ÿ</span></div>
        <div>é€²åº¦ï¼š<span id="progressText">0</span></div>
        <div>æ™‚é–“ï¼š<span id="timeText">00:00</span></div>
      </div>
    </section>

    <section id="playfield">
      <!-- Balloon åœ“ã€Hotdog & Lollipop ä»¥é€²åº¦æ¢å‘ˆç¾ -->
      <canvas id="balloon" width="320" height="240"></canvas>
      <div id="hotdogUI" class="stack">
        <div class="meter"><div id="hotdogFill"></div></div>
        <p>å’€åš¼æ¬¡æ•¸ç›®æ¨™ï¼š<span id="hotdogGoal">12</span></p>
      </div>
      <div id="lollipopUI" class="stack">
        <div class="meter"><div id="lollipopFill"></div></div>
        <p>èˆ”ä¸€èˆ”ï¼ˆå¿«é€Ÿé–‹åˆï¼‰ç›®æ¨™ï¼š<span id="lollipopGoal">20</span></p>
      </div>
    </section>

    <section id="result" class="hidden">
      <h2 id="resultTitle">å®Œæˆï¼</h2>
      <p id="resultDetail"></p>
      <button id="againBtn">å†ç©ä¸€æ¬¡</button>
    </section>

    <p class="hint">å°æé†’ï¼šå…è¨±éº¥å…‹é¢¨ã€ç›¡é‡åœ¨å®‰éœç’°å¢ƒï¼›è‹¥åµæ¸¬ä¸ç©©ï¼Œå¯æ”¹ç”¨ã€Œå¤§è² vs å°è²ã€ç­–ç•¥ã€‚</p>
  </main>
<!-- ğŸ”µ ç›¸æ©Ÿç•«é¢ï¼ˆåªåœ¨ç†±ç‹—é—œå¡ç”¨ï¼‰ -->
<video id="cam" width="320" height="240" playsinline autoplay muted class="hidden"></video>

<div id="hotdogUI" class="stack">
  <div class="meter"><div id="hotdogFill"></div></div>
  <p>å’€åš¼æ¬¡æ•¸ç›®æ¨™ï¼š<span id="hotdogGoal">12</span></p>
  <p>å˜´å‹æŒ‡æ¨™ MARï¼š<span id="marVal">0.00</span>
    ï¼ˆé–‹å£é–€æª» <span id="marOpen">â€”</span>ï¼›é–‰å£é–€æª» <span id="marClose">â€”</span>ï¼‰
  </p>
  <p id="calibTip">è«‹å…ˆã€Œé–‰å˜´ã€1 ç§’é€²è¡Œæ ¡æº–â€¦</p>
</div>

  <script src="main.js"></script>
</body>
</html>

* { box-sizing: border-box; }
body { font-family: system-ui, "Noto Sans TC", sans-serif; margin: 0; padding: 16px; }
main { max-width: 720px; margin: 0 auto; }
h1 { margin: 0 0 12px; }
.row { display: flex; align-items: center; gap: 12px; margin: 8px 0; flex-wrap: wrap; }
.bar { width: 220px; height: 10px; background: #eee; border-radius: 999px; overflow: hidden; }
#volBar { height: 100%; width: 0%; background: #6aa9ff; transition: width 80ms linear; }

#playfield { margin: 12px 0; display: grid; grid-template-columns: 1fr; gap: 12px; }
#balloon { background: #f9fafb; border: 1px solid #ddd; border-radius: 8px; }
.stack { padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
.meter { width: 100%; height: 16px; background: #eee; border-radius: 999px; overflow: hidden; margin-bottom: 8px; }
#hotdogFill, #lollipopFill { height: 100%; width: 0%; background: #34d399; transition: width 120ms linear; }

.hidden { display: none; }
.hint { color: #666; font-size: 12px; }
button { padding: 8px 12px; border-radius: 10px; border: 1px solid #ddd; background: white; cursor: pointer; }
button:hover { background: #f5f5f5; }
select { padding: 6px 10px; border-radius: 8px; border: 1px solid #ccc; }
// ====== åŸºç¤éº¥å…‹é¢¨éŸ³é‡åµæ¸¬ ======
let audioCtx, analyser, dataArray, micStream;
let rafId = null;
const volVal = document.getElementById('volVal');
const volBar = document.getElementById('volBar');
const stateText = document.getElementById('stateText');
const progressText = document.getElementById('progressText');
const timeText = document.getElementById('timeText');

const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const againBtn = document.getElementById('againBtn');
const modeSel = document.getElementById('mode');

const result = document.getElementById('result');
const resultTitle = document.getElementById('resultTitle');
const resultDetail = document.getElementById('resultDetail');

const balloonCanvas = document.getElementById('balloon');
const bctx = balloonCanvas.getContext('2d');
const hotdogFill = document.getElementById('hotdogFill');
const hotdogGoalEl = document.getElementById('hotdogGoal');
const lollipopFill = document.getElementById('lollipopFill');
const lollipopGoalEl = document.getElementById('lollipopGoal');

let game = null;
let startTime = 0;
let elapsed = 0;

// éŸ³é‡ï¼ˆRMSï¼‰è¨ˆç®—
function getVolume() {
  analyser.getByteTimeDomainData(dataArray);
  let sum = 0;
  for (let i = 0; i < dataArray.length; i++) {
    const v = (dataArray[i] - 128) / 128;
    sum += v * v;
  }
  const rms = Math.sqrt(sum / dataArray.length); // 0~ç´„0.5
  return rms;
}

// åˆå§‹åŒ–éº¥å…‹é¢¨
async function initAudio() {
  if (audioCtx) return;
  micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const source = audioCtx.createMediaStreamSource(micStream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  dataArray = new Uint8Array(analyser.fftSize);
  source.connect(analyser);
}

// ====== å…±ç”¨ UI ======
function setState(t) { stateText.textContent = t; }
function setProgress(v) { progressText.textContent = v; }
function setTime(ms) {
  const s = Math.floor(ms / 1000);
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  timeText.textContent = `${mm}:${ss}`;
}
function showResult(title, detail){
  resultTitle.textContent = title;
  resultDetail.textContent = detail;
  result.classList.remove('hidden');
}
function hideResult(){ result.classList.add('hidden'); }

// ====== æ ¸å¿ƒè¿´åœˆ ======
function loop() {
  const vol = getVolume();
  volVal.textContent = vol.toFixed(2);
  volBar.style.width = Math.min(100, (vol * 200)).toFixed(0) + '%';

  elapsed = performance.now() - startTime;
  setTime(elapsed);

  if (game) game.update(vol, elapsed);
  rafId = requestAnimationFrame(loop);
}

// ====== ä¸‰ç¨®é—œå¡çš„æœ€å°é‚è¼¯ ======
// åƒè€ƒé–€æª»ï¼ˆå¯ä¾å ´åœ°èª¿æ•´ï¼‰
const THRESH_LOUD = 0.12;      // å¤§è²ï¼ˆå¹æ°£ï¼‰
const THRESH_OPEN = 0.07;      // å˜´å·´å¼µé–‹ï¼ˆä¸€èˆ¬ï¼‰
const HYST = 0.02;             // å›æ»¯é¿å…æŠ–å‹•

// 1) ç†±ç‹—ï¼šå’€åš¼æ¬¡æ•¸ï¼ˆé–‹åˆæ¬¡æ•¸ï¼‰
function HotdogGame(target=12) {
  this.target = target;
  this.count = 0;
  this.awaitClose = false; // true è¡¨ç¤ºå‰›é–‹å£ï¼Œç­‰é–‰å£
  hotdogGoalEl.textContent = target;

  this.update = (vol) => {
    // é–‹å£ï¼šè¶…éé–€æª»ï¼Œä¸”åŸæœ¬ä¸æ˜¯é–‹å£ç‹€æ…‹
    if (!this.awaitClose && vol > THRESH_OPEN) {
      this.awaitClose = true;
      setState('å¼µå£');
    }
    // é–‰å£ï¼šä½æ–¼ (THRESH_OPEN - HYST) æ‰ç®—ä¸€æ¬¡
    if (this.awaitClose && vol < (THRESH_OPEN - HYST)) {
      this.awaitClose = false;
      this.count++;
      setProgress(`${this.count}/${this.target}`);
      hotdogFill.style.width = `${Math.min(100, this.count / this.target * 100)}%`;
      setState('é–‰å£');
      if (this.count >= this.target) {
        endGame(`ç†±ç‹—åˆ‡å®Œï¼`, `ä½ å®Œæˆ ${this.count} æ¬¡å’€åš¼ï¼Œç”¨æ™‚ ${timeText.textContent}`);
      }
    }
  };
}

// 2) æ°£çƒï¼šç¶­æŒå¤§è²å¹æ°£è®“åŠå¾‘æˆé•·ï¼›æ²’å¹å°±æ…¢æ…¢ç¸®
function BalloonGame(targetRadius=100) {
  this.r = 20;
  this.target = targetRadius;

  this.update = (vol) => {
    if (vol > THRESH_LOUD) {
      this.r += 1.5; // å¹æ°£æ™‚æˆé•·
      setState('ç”¨åŠ›å¹ï¼');
    } else {
      this.r -= 0.6; // æ²’å¹æ™‚ç·©æ…¢ç¸®
      setState('å†å¤§è²ä¸€é»');
    }
    this.r = Math.max(10, Math.min(this.r, this.target + 10));
    const pct = Math.min(100, (this.r / this.target) * 100);
    setProgress(`${pct.toFixed(0)}%`);
    drawBalloon(this.r);
    if (this.r >= this.target) {
      endGame(`æ°£çƒçˆ†å›‰ï¼`, `ä½ æŠŠæ°£çƒå¹åˆ°ç›®æ¨™å¤§å°ï¼Œç”¨æ™‚ ${timeText.textContent}`);
    }
  };
}

// 3) æ£’æ£’ç³–ï¼šå¿«é€Ÿã€Œå°å¹…ã€é–‹åˆè¦–ç‚ºä¸€æ¬¡èˆ”ï¼ˆåµæ¸¬ç¯€å¥ï¼‰
// ç©æ³•ï¼šçŸ­æ™‚é–“å…§é”åˆ° N æ¬¡å¿«é€Ÿé–‹åˆ
function LollipopGame(target=20) {
  this.target = target;
  this.count = 0;
  this.state = 'idle';
  this.lastPeak = 0;

  this.update = (vol, t) => {
    // å¿«é€Ÿé–‹å£å³°å€¼ï¼ˆ>THRESH_OPENï¼‰ï¼Œå…©æ¬¡å³°ä¹‹é–“è¦é–“éš” > 180ms é¿å…é‡è¤‡è¨ˆæ•¸
    if (vol > THRESH_OPEN && (t - this.lastPeak) > 180) {
      this.lastPeak = t;
      this.count++;
      lollipopFill.style.width = `${Math.min(100, this.count / this.target * 100)}%`;
      setProgress(`${this.count}/${this.target}`);
      setState('èˆ”ï¼');
      if (this.count >= this.target) {
        endGame(`æ£’æ£’ç³–èˆ”å¥½ï¼`, `ä½ å®Œæˆ ${this.count} æ¬¡ï¼Œç”¨æ™‚ ${timeText.textContent}`);
      }
    } else if (vol < (THRESH_OPEN - HYST)) {
      setState('æº–å‚™èˆ”');
    }
  };
}

// ç•«æ°£çƒ
function drawBalloon(r) {
  bctx.clearRect(0,0,balloonCanvas.width, balloonCanvas.height);
  const cx = balloonCanvas.width/2, cy = balloonCanvas.height/2 + 20;
  // çƒ
  bctx.beginPath();
  bctx.arc(cx, cy, r, 0, Math.PI*2);
  bctx.fillStyle = '#f87171';
  bctx.fill();
  // ç¹©å­
  bctx.beginPath();
  bctx.moveTo(cx, cy + r);
  bctx.lineTo(cx, cy + r + 60);
  bctx.strokeStyle = '#555';
  bctx.lineWidth = 2;
  bctx.stroke();
}

// ====== éŠæˆ²ç”Ÿå‘½é€±æœŸ ======
async function startGame() {
  hideResult();
  await initAudio();
  startTime = performance.now();
  setProgress(0);
  setState('åµæ¸¬ä¸­â€¦');

  // é¡¯ç¤ºå°æ‡‰ UI
  document.getElementById('hotdogUI').classList.add('hidden');
  document.getElementById('lollipopUI').classList.add('hidden');
  if (modeSel.value === 'balloon') {
    // balloon canvas é¡¯ç¤º
    balloonCanvas.classList.remove('hidden');
    drawBalloon(20);
    game = new BalloonGame(100);
  } else if (modeSel.value === 'hotdog') {
    balloonCanvas.classList.add('hidden');
    document.getElementById('hotdogUI').classList.remove('hidden');
    game = new HotdogGame(12);
  } else {
    balloonCanvas.classList.add('hidden');
    document.getElementById('lollipopUI').classList.remove('hidden');
    game = new LollipopGame(20);
  }

  if (!rafId) rafId = requestAnimationFrame(loop);
}

function endGame(title, detail){
  showResult(title, detail);
  setState('å®Œæˆ');
  stopLoopKeepMic();
}

function stopLoopKeepMic(){
  if (rafId) cancelAnimationFrame(rafId);
  rafId = null;
}

function resetAll(){
  stopLoopKeepMic();
  setProgress(0);
  setTime(0);
  setState('å¾…æ©Ÿ');
  hideResult();
  game = null;
  bctx.clearRect(0,0,balloonCanvas.width, balloonCanvas.height);
  hotdogFill.style.width = '0%';
  lollipopFill.style.width = '0%';
}

// äº‹ä»¶
startBtn.addEventListener('click', startGame);
resetBtn.addEventListener('click', resetAll);
againBtn.addEventListener('click', resetAll);

// é›¢é–‹é é¢æ™‚é—œéº¥å…‹é¢¨
window.addEventListener('beforeunload', () => {
  if (micStream) micStream.getTracks().forEach(t => t.stop());
});
